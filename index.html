<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PHIẾU THU INTERNET</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex justify-center items-center min-h-screen p-4">
  <div class="bg-white rounded-2xl shadow-lg w-full max-w-2xl p-6 space-y-4">
    <h1 class="text-2xl font-bold text-center mb-4">PHIẾU THU INTERNET</h1>

    <!-- Loading message -->
    <div id="loading" class="text-center text-gray-500">Đang tải dữ liệu...</div>

    <!-- Main Form -->
    <div id="mainForm" class="hidden space-y-4">
      <!-- Khối 1: Chọn khách hàng -->
      <div class="bg-gray-50 p-4 rounded-xl shadow-sm">
        <label class="block font-semibold mb-2">Chọn Khách Hàng:</label>
        <div class="flex space-x-2">
          <select id="tenKH" class="flex-1 border rounded-lg p-2 focus:ring focus:ring-blue-200"></select>
          <button id="btnAddKH" class="bg-green-500 text-white px-4 rounded-lg hover:bg-green-600">+</button>
        </div>
      </div>

      <!-- Khối 2: Thông tin khách hàng -->
      <div id="infoSection" class="hidden bg-gray-50 p-4 rounded-xl shadow-sm space-y-2">
        <div><span class="font-semibold">Gói cước:</span> <span id="infoGoiCuoc" class="text-blue-700 font-bold"></span></div>
        <div><span class="font-semibold">Hạn dùng cũ:</span> <span id="infoHanDung" class="text-red-600 font-bold"></span></div>
        <div><span class="font-semibold">Ngày nộp gần nhất:</span> <span id="infoNgayNop"></span></div>
        <div><span class="font-semibold">Số tiền trước:</span> <span id="infoSoTien"></span></div>
        <div class="flex flex-col">
          <span class="font-semibold mb-1">Ghi chú:</span>
          <input id="infoGhiChu" class="border rounded-lg p-2 w-full" readonly />
        </div>
      </div>

      <!-- Khối 3: Nhập thanh toán -->
      <div id="paySection" class="hidden bg-white p-4 rounded-xl shadow-sm space-y-3">
        <div>
          <label class="font-semibold block mb-1">Số tiền:</label>
          <input id="soTien" type="text" inputmode="numeric"
                 class="border rounded-lg p-2 w-full font-semibold text-lg text-blue-600"
                 placeholder="Nhập số tiền (VD: 140.000)" />
        </div>
        <div>
          <span class="font-semibold">Số tháng: </span><span id="soThang" class="font-bold"></span>
        </div>
        <div>
          <span class="font-semibold">Hạn dùng mới (dự kiến): </span><span id="hanDungMoi" class="font-bold text-green-700"></span>
        </div>
        <div>
          <label class="font-semibold block mb-1">Ghi chú mới:</label>
          <input id="ghiChuMoi" class="border rounded-lg p-2 w-full" placeholder="Thông tin thêm..." />
        </div>
        <button id="btnPay" class="bg-blue-600 text-white w-full py-2 rounded-lg hover:bg-blue-700 font-semibold">Xác Nhận Nộp Tiền</button>
      </div>
    </div>
  </div>

  <!-- Modal thêm KH -->
  <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center">
    <div class="bg-white p-6 rounded-xl shadow-lg w-96 space-y-3 relative">
      <h2 class="text-lg font-bold text-center mb-2">Thêm Khách Hàng Mới</h2>
      <input id="newTenKH" class="border rounded-lg p-2 w-full" placeholder="Tên khách hàng" />
      <input id="newSoTien" type="text" inputmode="numeric" class="border rounded-lg p-2 w-full" placeholder="Số tiền ban đầu (VD: 140.000)" />
      <input id="newHanDung" maxlength="10" class="border rounded-lg p-2 w-full" placeholder="Hạn dùng (dd/mm/yyyy)" />
      <input id="newGoiCuoc" type="text" inputmode="numeric" class="border rounded-lg p-2 w-full" placeholder="Gói cước (VD: 70.000)" />
      <textarea id="newGhiChu" rows="1" class="border rounded-lg p-2 w-full" placeholder="Ghi chú"></textarea>
      <div class="flex space-x-2 pt-2">
        <button id="btnSaveNewKH" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">Tạo</button>
        <button id="btnCancelNewKH" class="flex-1 bg-gray-400 text-white py-2 rounded-lg hover:bg-gray-500">Hủy</button>
      </div>
    </div>
  </div>

  <script>
    const apiUrl = "https://script.google.com/macros/s/AKfycbweaNkEa1xWCmcvWkdFQv6lSXwvMx0C3XVEcBHtlFUc_mY2DvY7D0SS2JGG4yyujUu9/exec"; // <-- thay bằng link WebApp của bạn

    const loading = document.getElementById("loading");
    const mainForm = document.getElementById("mainForm");
    const infoSection = document.getElementById("infoSection");
    const paySection = document.getElementById("paySection");
    const tenKHSelect = document.getElementById("tenKH");
    const btnAddKH = document.getElementById("btnAddKH");
    const btnPay = document.getElementById("btnPay");

    let customers = [];
    let selectedKH = null;

    // --- Định dạng tiền ---
    function formatCurrency(value) {
      if (!value) return "";
      return Number(value.toString().replace(/\D/g, "")).toLocaleString("vi-VN");
    }

    // --- Định dạng ngày tự động ---
    const hanDungInput = document.getElementById("newHanDung");
    hanDungInput?.addEventListener("input", e => {
      let v = e.target.value.replace(/\D/g, "").slice(0, 8);
      if (v.length >= 5) v = v.replace(/(\d{2})(\d{2})(\d{0,4})/, "$1/$2/$3");
      else if (v.length >= 3) v = v.replace(/(\d{2})(\d{0,2})/, "$1/$2");
      e.target.value = v;
    });

    // --- Load dữ liệu khách hàng ---
    async function loadCustomers() {
      loading.classList.remove("hidden");
      mainForm.classList.add("hidden");
      const res = await fetch(`${apiUrl}?action=list`);
      const data = await res.json();
      customers = data.customers || [];
      tenKHSelect.innerHTML = `<option value="">-- Mời chọn tên khách hàng --</option>` +
        customers.map(c => `<option value="${c.tenKH}">${c.tenKH}</option>`).join("");
      loading.classList.add("hidden");
      mainForm.classList.remove("hidden");
    }

    // --- Khi chọn KH ---
    tenKHSelect.addEventListener("change", () => {
      const name = tenKHSelect.value;
      if (!name) {
        infoSection.classList.add("hidden");
        paySection.classList.add("hidden");
        return;
      }
      selectedKH = customers.find(c => c.tenKH === name);
      document.getElementById("infoGoiCuoc").innerText = formatCurrency(selectedKH.goiCuoc) + " VND/tháng";
      document.getElementById("infoHanDung").innerText = selectedKH.hanDung || "";
      document.getElementById("infoNgayNop").innerText = selectedKH.ngayNop || "";
      document.getElementById("infoSoTien").innerText = formatCurrency(selectedKH.soTien) + " VND";
      document.getElementById("infoGhiChu").value = selectedKH.ghiChu || "";
      infoSection.classList.remove("hidden");
      paySection.classList.remove("hidden");
      document.getElementById("soTien").value = "";
      document.getElementById("soThang").innerText = "";
      document.getElementById("hanDungMoi").innerText = "";
    });

    // --- Khi nhập số tiền ---
    document.getElementById("soTien").addEventListener("input", e => {
      e.target.value = formatCurrency(e.target.value);
      if (!selectedKH) return;
      const goi = Number(selectedKH.goiCuoc) || 0;
      const soTien = Number(e.target.value.replace(/\D/g, ""));
      const months = goi ? Math.floor(soTien / goi) : 0;
      document.getElementById("soThang").innerText = months ? `${months} tháng` : "";
      if (months > 0 && selectedKH.hanDungDate) {
        const newDate = new Date(selectedKH.hanDungDate);
        newDate.setMonth(newDate.getMonth() + months);
        const d = ("0" + newDate.getDate()).slice(-2);
        const m = ("0" + (newDate.getMonth() + 1)).slice(-2);
        const y = newDate.getFullYear();
        document.getElementById("hanDungMoi").innerText = `${d}/${m}/${y}`;
      }
    });

    // --- Xác nhận nộp tiền ---
    btnPay.addEventListener("click", async () => {
      if (!selectedKH) return alert("Chưa chọn khách hàng!");
      btnPay.disabled = true;
      const soTien = Number(document.getElementById("soTien").value.replace(/\D/g, ""));
      const ghiChu = document.getElementById("ghiChuMoi").value;
      const body = {
        action: "pay",
        tenKH: selectedKH.tenKH,
        soTien,
        ghiChu
      };
      const res = await fetch(apiUrl, {
        method: "POST",
        body: JSON.stringify(body),
      });
      const data = await res.json();
      alert(`Đã nộp tiền cho ${data.tenKH}, hạn dùng mới đến ${data.hanDung}`);
      await loadCustomers();
      tenKHSelect.value = "";
      infoSection.classList.add("hidden");
      paySection.classList.add("hidden");
      btnPay.disabled = false;
    });

    // --- Modal thêm KH ---
    const modal = document.getElementById("modal");
    btnAddKH.addEventListener("click", () => modal.classList.remove("hidden"));
    document.getElementById("btnCancelNewKH").addEventListener("click", () => modal.classList.add("hidden"));
    document.getElementById("btnSaveNewKH").addEventListener("click", async () => {
      document.getElementById("btnSaveNewKH").disabled = true;
      const body = {
        action: "add",
        tenKH: document.getElementById("newTenKH").value.trim(),
        soTien: Number(document.getElementById("newSoTien").value.replace(/\D/g, "")),
        hanDung: document.getElementById("newHanDung").value,
        goiCuoc: Number(document.getElementById("newGoiCuoc").value.replace(/\D/g, "")),
        ghiChu: document.getElementById("newGhiChu").value.trim()
      };
      const res = await fetch(apiUrl, { method: "POST", body: JSON.stringify(body) });
      const data = await res.json();
      alert(`Đã thêm khách hàng ${data.tenKH}, hạn dùng đến ${data.hanDung}`);
      modal.classList.add("hidden");
      await loadCustomers();
      document.getElementById("btnSaveNewKH").disabled = false;
    });

    loadCustomers();
  </script>
</body>
</html>
